# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license
# YOLOv5 Continuous Integration (CI) GitHub Actions tests
name: YOLOv5 CI

# æœ€å°æƒé™åŸåˆ™é…ç½®
permissions:
  contents: read
  actions: read
  artifacts: write  # ç”¨äºä¸Šä¼ æµ‹è¯•/åŸºå‡†æµ‹è¯•æ—¥å¿—

# CI è§¦å‘æ¡ä»¶
on:
  push:
    branches: [master]  # master åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  pull_request:
    branches: [master]  # master åˆ†æ”¯PRæ—¶è§¦å‘
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©UTC 0ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘CI

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç»Ÿä¸€é…ç½®ï¼Œä¾¿äºç»´æŠ¤ï¼‰
env:
  # UV è™šæ‹Ÿç¯å¢ƒè·¯å¾„ï¼ˆè·¨ç³»ç»Ÿå…¼å®¹ï¼ŒLinux/macOS/Windowsï¼‰
  UV_VENV_PATH: ${{ github.workspace }}/uv-venv
  # ONNX ç›¸å…³ä¾èµ–å…¼å®¹ç‰ˆæœ¬ï¼ˆè§£å†³ç‰ˆæœ¬å†²çªï¼‰
  ONNX_VERSION: "1.20.0"
  ONNXSCRIPT_VERSION: "0.11.0"
  ONNX_SIMPLIFIER_VERSION: "0.4.1"
  # æµ‹è¯•å‚æ•°é…ç½®
  IMGSZ_BENCHMARK: 320
  IMGSZ_TEST: 64
  BATCH_SIZE_TEST: 32
  EPOCHS_TEST: 1
  MODEL: "yolov5n"

jobs:
  # ä»»åŠ¡1ï¼šåŸºå‡†æµ‹è¯•ï¼ˆæ£€æµ‹/åˆ†å‰²æ¨¡å‹æ€§èƒ½ + ONNXå¯¼å‡ºéªŒè¯ï¼‰
  Benchmarks:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # ä¸€ä¸ªé…ç½®å¤±è´¥ä¸å½±å“å…¶ä»–é…ç½®
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11"]
        model: [yolov5n]
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v6

      # æ­¥éª¤2ï¼šé…ç½®Pythonç¯å¢ƒ
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"  # å¯ç”¨pipç¼“å­˜ï¼ˆå¯é€‰ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…ï¼‰

      # æ­¥éª¤3ï¼šå®‰è£…uvåŒ…ç®¡ç†å™¨ï¼ˆç°ä»£PythonåŒ…ç®¡ç†å™¨ï¼‰
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"  # ä½¿ç”¨æœ€æ–°ç‰ˆuv

      # æ­¥éª¤4ï¼šåˆ›å»ºUVè™šæ‹Ÿç¯å¢ƒï¼ˆè§£å†³ã€ŒNo virtual environment foundã€æŠ¥é”™ï¼‰
      - name: Create UV virtual environment
        run: |
          # åˆ›å»ºuvè™šæ‹Ÿç¯å¢ƒï¼ˆæŒ‡å®šè·¯å¾„ï¼‰
          uv venv ${{ env.UV_VENV_PATH }}
          # éªŒè¯è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæˆåŠŸ
          if [ -d "${{ env.UV_VENV_PATH }}" ]; then
            echo "âœ… UV virtual environment created at ${{ env.UV_VENV_PATH }}"
          else
            echo "âŒ UV virtual environment creation failed"
            exit 1
          fi
        shell: bash

      # æ­¥éª¤5ï¼šæ¿€æ´»UVè™šæ‹Ÿç¯å¢ƒå¹¶æ·»åŠ åˆ°ç³»ç»ŸPATHï¼ˆå…³é”®ï¼šåç»­å‘½ä»¤ä½¿ç”¨è¯¥ç¯å¢ƒï¼‰
      - name: Activate UV virtual environment
        run: |
          # Linux/macOSæ¿€æ´»è„šæœ¬è·¯å¾„
          if [[ "$RUNNER_OS" == "Linux" || "$RUNNER_OS" == "macOS" ]]; then
            VENV_BIN_PATH="${{ env.UV_VENV_PATH }}/bin"
            echo "$VENV_BIN_PATH" >> $GITHUB_PATH
            # éªŒè¯æ¿€æ´»ï¼ˆæ‰§è¡Œpython --versionç¡®è®¤ç¯å¢ƒï¼‰
            $VENV_BIN_PATH/python --version
          # Windowsæ¿€æ´»è„šæœ¬è·¯å¾„
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_BIN_PATH="${{ env.UV_VENV_PATH }}/Scripts"
            echo "$VENV_BIN_PATH" >> $GITHUB_PATH
            # éªŒè¯æ¿€æ´»
            $VENV_BIN_PATH/python --version
          fi
        shell: bash

      # æ­¥éª¤6ï¼šç¼“å­˜UVä¾èµ–å’Œæ•°æ®é›†ï¼ˆåŠ é€ŸCIè¿è¡Œï¼Œé¿å…é‡å¤ä¸‹è½½ï¼‰
      - name: Cache UV dependencies and datasets
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ${{ env.UV_VENV_PATH }}
            datasets/
          key: ${{ matrix.os }}-uv-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ matrix.os }}-uv-${{ matrix.python-version }}-

      # æ­¥éª¤7ï¼šå®‰è£…ä¾èµ–ï¼ˆæ ¸å¿ƒï¼šå¼ºåˆ¶å®‰è£…ONNXä¾èµ–ï¼Œè§£å†³æœªä¸‹è½½é—®é¢˜ï¼‰
      - name: Install dependencies
        run: |
          # æ¸…ç†UVç¼“å­˜ï¼ˆé¿å…æ—§è§£æé€»è¾‘å¹²æ‰°ï¼‰
          uv cache clean
          # å®‰è£…ä¾èµ–ï¼šæ˜¾å¼æŒ‡å®šONNXç›¸å…³ç‰ˆæœ¬ï¼Œå¼ºåˆ¶å®‰è£…
          uv pip install -U \
            -r requirements.txt \
            coremltools \
            openvino-dev \
            "tensorflow<=2.19.0" \
            onnx==${{ env.ONNX_VERSION }} \
            onnxscript==${{ env.ONNXSCRIPT_VERSION }} \
            onnx-simplifier>=${{ env.ONNX_SIMPLIFIER_VERSION }} \
            --extra-index-url https://download.pytorch.org/whl/cpu
          # å…³é”®éªŒè¯ï¼šç¡®è®¤ONNXä¾èµ–å®‰è£…å¹¶èƒ½å¯¼å…¥ï¼ˆå¤±è´¥åˆ™ç»ˆæ­¢CIï¼‰
          python -c "import onnx, onnxscript, onnxsim; print(f'onnx version: {onnx.__version__}'); print(f'onnxscript version: {onnxscript.__version__}'); print('âœ… ONNX dependencies imported successfully!')"
          # æ£€æŸ¥Ultralyticsç¯å¢ƒå¹¶åˆ—å‡ºå·²å®‰è£…åŒ…ï¼ˆè°ƒè¯•ç”¨ï¼‰
          yolo checks
          uv pip list
        shell: bash

      # æ­¥éª¤8ï¼šåŸºå‡†æµ‹è¯• - æ£€æµ‹æ¨¡å‹
      - name: Benchmark DetectionModel
        run: |
          python benchmarks.py \
            --data coco128.yaml \
            --weights ${{ matrix.model }}.pt \
            --img ${{ env.IMGSZ_BENCHMARK }} \
            --hard-fail 0.29
        shell: bash

      # æ­¥éª¤9ï¼šåŸºå‡†æµ‹è¯• - åˆ†å‰²æ¨¡å‹
      - name: Benchmark SegmentationModel
        run: |
          python benchmarks.py \
            --data coco128-seg.yaml \
            --weights ${{ matrix.model }}-seg.pt \
            --img ${{ env.IMGSZ_BENCHMARK }} \
            --hard-fail 0.22
        shell: bash

      # æ­¥éª¤10ï¼šæµ‹è¯•é¢„æµ‹ - ONNXå¯¼å‡º+æ¨ç†éªŒè¯
      - name: Test predictions (ONNX)
        run: |
          # å¯¼å‡ºONNXæ ¼å¼
          python export.py --weights ${{ matrix.model }}-cls.pt --include onnx --img 224
          # éªŒè¯æ£€æµ‹/åˆ†å‰²/åˆ†ç±»çš„ONNXæ¨ç†
          python detect.py --weights ${{ matrix.model }}.onnx --img ${{ env.IMGSZ_BENCHMARK }}
          python segment/predict.py --weights ${{ matrix.model }}-seg.onnx --img ${{ env.IMGSZ_BENCHMARK }}
          python classify/predict.py --weights ${{ matrix.model }}-cls.onnx --img 224
        shell: bash

      # æ­¥éª¤11ï¼šä¸Šä¼ åŸºå‡†æµ‹è¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¸Šä¼ ï¼Œä¾¿äºè°ƒè¯•ï¼‰
      - name: Upload Benchmarks artifacts
        uses: actions/upload-artifact@v4
        if: failure()  # ä»…åœ¨ä»»åŠ¡å¤±è´¥æ—¶ä¸Šä¼ 
        with:
          name: ${{ matrix.os }}-${{ matrix.python-version }}-benchmarks-logs
          path: |
            runs/
            *.log
            ${{ env.UV_VENV_PATH }}/lib/python*/site-packages/onnx*  # å¯é€‰ï¼šä¸Šä¼ ONNXä¾èµ–å®‰è£…ç›®å½•
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©

  # ä»»åŠ¡2ï¼šå…¨åŠŸèƒ½æµ‹è¯•ï¼ˆè·¨ç³»ç»Ÿ/Pythonç‰ˆæœ¬çš„æ£€æµ‹/åˆ†å‰²/åˆ†ç±»æµ‹è¯•ï¼‰
  Tests:
    timeout-minutes: 60  # è¶…æ—¶æ—¶é—´ï¼š60åˆ†é’Ÿ
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]  # è§„é¿macos-latestçš„å·²çŸ¥bug
        python-version: ["3.11"]
        model: [yolov5n]
        include:
          - os: ubuntu-latest
            python-version: "3.8"  # å…¼å®¹PyTorch 1.8.0ï¼ˆæœ€ä½æ”¯æŒç‰ˆæœ¬ï¼‰
            model: [yolov5n]
            torch: "1.8.0"  # æ ‡è®°éœ€è¦å®‰è£…æ—§ç‰ˆPyTorch
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v6

      # æ­¥éª¤2ï¼šé…ç½®Pythonç¯å¢ƒ
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      # æ­¥éª¤3ï¼šå®‰è£…uvåŒ…ç®¡ç†å™¨
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      # æ­¥éª¤4ï¼šåˆ›å»ºUVè™šæ‹Ÿç¯å¢ƒï¼ˆè§£å†³è™šæ‹Ÿç¯å¢ƒæŠ¥é”™ï¼‰
      - name: Create UV virtual environment
        run: |
          uv venv ${{ env.UV_VENV_PATH }}
          # éªŒè¯è™šæ‹Ÿç¯å¢ƒåˆ›å»º
          if [ -d "${{ env.UV_VENV_PATH }}" ]; then
            echo "âœ… UV virtual environment created at ${{ env.UV_VENV_PATH }}"
          else
            echo "âŒ UV virtual environment creation failed"
            exit 1
          fi
        shell: bash

      # æ­¥éª¤5ï¼šæ¿€æ´»UVè™šæ‹Ÿç¯å¢ƒå¹¶æ·»åŠ åˆ°PATH
      - name: Activate UV virtual environment
        run: |
          if [[ "$RUNNER_OS" == "Linux" || "$RUNNER_OS" == "macOS" ]]; then
            VENV_BIN_PATH="${{ env.UV_VENV_PATH }}/bin"
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_BIN_PATH="${{ env.UV_VENV_PATH }}/Scripts"
          fi
          echo "$VENV_BIN_PATH" >> $GITHUB_PATH
          # éªŒè¯Pythonç¯å¢ƒ
          $VENV_BIN_PATH/python --version
        shell: bash

      # æ­¥éª¤6ï¼šç¼“å­˜UVä¾èµ–å’Œæ•°æ®é›†
      - name: Cache UV dependencies and datasets
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ${{ env.UV_VENV_PATH }}
            datasets/
          key: ${{ matrix.os }}-uv-${{ matrix.python-version }}-${{ matrix.torch || 'latest' }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ matrix.os }}-uv-${{ matrix.python-version }}-${{ matrix.torch || 'latest' }}-

      # æ­¥éª¤7ï¼šå®‰è£…ä¾èµ–ï¼ˆå¤„ç†æ—§ç‰ˆPyTorchï¼Œå¼ºåˆ¶å®‰è£…æ ¸å¿ƒä¾èµ–ï¼‰
      - name: Install dependencies
        shell: bash  # è·¨ç³»ç»Ÿå…¼å®¹
        run: |
          # æ¸…ç†UVç¼“å­˜
          uv cache clean
          # å¤„ç†PyTorch 1.8.0ï¼ˆæœ€ä½ç‰ˆæœ¬ï¼‰çš„å®‰è£…
          torch_pkgs=""
          if [ "${{ matrix.torch }}" == "1.8.0" ]; then
            # PyTorch 1.8.0 CPUç‰ˆæœ¬éœ€è¦æŒ‡å®šæ—§ç´¢å¼•
            torch_pkgs="torch==1.8.0+cpu torchvision==0.9.0+cpu -f https://download.pytorch.org/whl/torch_stable.html"
          fi
          # å®‰è£…ä¾èµ–ï¼šåŒ…å«æ—§ç‰ˆPyTorchï¼ˆè‹¥æœ‰ï¼‰
          uv pip install -U \
            -r requirements.txt \
            $torch_pkgs \
            --extra-index-url https://download.pytorch.org/whl/cpu
          # éªŒè¯ç¯å¢ƒ
          yolo checks
          python -m pip list
        shell: bash

      # æ­¥éª¤8ï¼šæµ‹è¯•æ£€æµ‹æ¨¡å‹ï¼ˆè®­ç»ƒ/éªŒè¯/æ¨ç†/å¯¼å‡ºï¼‰
      - name: Test detection
        shell: bash
        run: |
          m=${{ matrix.model }}  # å®˜æ–¹æƒé‡
          b=runs/train/exp/weights/best  # è®­ç»ƒåçš„æƒé‡
          # è®­ç»ƒæ¨¡å‹ï¼ˆ1 epochï¼ŒCPUï¼‰
          python train.py \
            --imgsz ${{ env.IMGSZ_TEST }} \
            --batch ${{ env.BATCH_SIZE_TEST }} \
            --weights $m.pt \
            --cfg $m.yaml \
            --epochs ${{ env.EPOCHS_TEST }} \
            --device cpu
          # éªŒè¯+æ¨ç†ï¼ˆCPUï¼‰
          for d in cpu; do
            for w in $m $b; do
              python val.py --imgsz ${{ env.IMGSZ_TEST }} --batch ${{ env.BATCH_SIZE_TEST }} --weights $w.pt --device $d
              python detect.py --imgsz ${{ env.IMGSZ_TEST }} --weights $w.pt --device $d
            done
          done
          # æµ‹è¯•Hubé…ç½®ã€æ¨¡å‹æ„å»ºã€TorchScriptå¯¼å‡º
          python hubconf.py --model $m
          python models/yolo.py --cfg $m.yaml
          python export.py --weights $m.pt --img ${{ env.IMGSZ_TEST }} --include torchscript
          # æµ‹è¯•Torch HubåŠ è½½å’ŒJITè¿½è¸ª
          python - <<EOF
          import torch
          im = torch.zeros([1, 3, ${{ env.IMGSZ_TEST }}, ${{ env.IMGSZ_TEST }}])
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path+'.pt', source='local')
              print(model('data/images/bus.jpg'))
              model(im)  # é¢„çƒ­æ¨¡å‹
              torch.jit.trace(model, [im])
          EOF
        shell: bash

      # æ­¥éª¤9ï¼šæµ‹è¯•åˆ†å‰²æ¨¡å‹
      - name: Test segmentation
        shell: bash
        run: |
          m=${{ matrix.model }}-seg  # å®˜æ–¹æƒé‡
          b=runs/train-seg/exp/weights/best  # è®­ç»ƒåçš„æƒé‡
          # è®­ç»ƒæ¨¡å‹ï¼ˆå¸¦æƒé‡/ç©ºæƒé‡ï¼‰
          python segment/train.py \
            --imgsz ${{ env.IMGSZ_TEST }} \
            --batch ${{ env.BATCH_SIZE_TEST }} \
            --weights $m.pt \
            --cfg $m.yaml \
            --epochs ${{ env.EPOCHS_TEST }} \
            --device cpu
          python segment/train.py \
            --imgsz ${{ env.IMGSZ_TEST }} \
            --batch ${{ env.BATCH_SIZE_TEST }} \
            --weights '' \
            --cfg $m.yaml \
            --epochs ${{ env.EPOCHS_TEST }} \
            --device cpu
          # éªŒè¯+æ¨ç†+å¯¼å‡º
          for d in cpu; do
            for w in $m $b; do
              python segment/val.py --imgsz ${{ env.IMGSZ_TEST }} --batch ${{ env.BATCH_SIZE_TEST }} --weights $w.pt --device $d
              python segment/predict.py --imgsz ${{ env.IMGSZ_TEST }} --weights $w.pt --device $d
              python export.py --weights $w.pt --img ${{ env.IMGSZ_TEST }} --include torchscript --device $d
            done
          done
        shell: bash

      # æ­¥éª¤10ï¼šæµ‹è¯•åˆ†ç±»æ¨¡å‹
      - name: Test classification
        shell: bash
        run: |
          m=${{ matrix.model }}-cls.pt  # å®˜æ–¹æƒé‡
          b=runs/train-cls/exp/weights/best.pt  # è®­ç»ƒåçš„æƒé‡
          # è®­ç»ƒæ¨¡å‹
          python classify/train.py \
            --imgsz 32 \
            --model $m \
            --data mnist160 \
            --epochs ${{ env.EPOCHS_TEST }}
          # éªŒè¯+æ¨ç†
          python classify/val.py --imgsz 32 --weights $b --data ../datasets/mnist160
          python classify/predict.py --imgsz 32 --weights $b --source ../datasets/mnist160/test/7/60.png
          python classify/predict.py --imgsz 32 --weights $m --source data/images/bus.jpg
          # å¯¼å‡ºTorchScript
          python export.py --weights $b --img ${{ env.IMGSZ_TEST }} --include torchscript
          # æµ‹è¯•Torch HubåŠ è½½
          python - <<EOF
          import torch
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
          EOF
        shell: bash

      # æ­¥éª¤11ï¼šä¸Šä¼ æµ‹è¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¸Šä¼ ï¼‰
      - name: Upload Tests artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.torch || 'latest' }}-tests-logs
          path: runs/
          retention-days: 7

  # ä»»åŠ¡3ï¼šç»“æœæ±‡æ€»ï¼ˆå¤±è´¥æ—¶å‘é€Slacké€šçŸ¥ï¼‰
  Summary:
    runs-on: ubuntu-latest
    needs: [Benchmarks, Tests]  # ä¾èµ–å‰ä¸¤ä¸ªä»»åŠ¡
    if: always()  # æ— è®ºå‰åºä»»åŠ¡æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œæ­¤ä»»åŠ¡
    steps:
      - name: Send Slack notification on failure/cancellation
        if: |
          (needs.Benchmarks.result == 'failure' || needs.Tests.result == 'failure' ||
           needs.Benchmarks.result == 'cancelled' || needs.Tests.result == 'cancelled') &&
          github.repository == 'ultralytics/yolov5' &&  # ä»…åœ¨å®˜æ–¹ä»“åº“ç”Ÿæ•ˆï¼ˆå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
          (github.event_name == 'schedule' || github.event_name == 'push') &&
          github.run_attempt == '1'  # ä»…ç¬¬ä¸€æ¬¡è¿è¡Œå¤±è´¥æ—¶é€šçŸ¥
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_YOLO }}  # éœ€åœ¨ä»“åº“Secretsä¸­é…ç½®
          payload: |
            {
              "text": "<!channel> GitHub Actions error for ${{ github.workflow }} âŒ\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name }}\n*Benchmarks Result:* ${{ needs.Benchmarks.result }}\n*Tests Result:* ${{ needs.Tests.result }}"
            }
