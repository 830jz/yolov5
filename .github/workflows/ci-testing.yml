# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license
# YOLOv5 Continuous Integration (CI) GitHub Actions tests
name: YOLOv5 CI

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: read
  actions: read  # å¯é€‰ï¼šç”¨äºç¼“å­˜å’ŒArtifactæ“ä½œ

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©UTC 0ç‚¹è¿è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆå‡å°‘ç¡¬ç¼–ç ï¼Œä¾¿äºç»´æŠ¤ï¼‰
env:
  PYTHON_VERSION: "3.11"
  MODEL: "yolov5n"
  IMGSZ_BENCHMARK: 320
  IMGSZ_TEST: 64
  BATCH_SIZE_TEST: 32
  EPOCHS_TEST: 1
  # å…¼å®¹ç‰ˆæœ¬é…ç½®ï¼ˆå…³é”®ï¼šè§£å†³onnxä¸onnxscriptç‰ˆæœ¬å†²çªï¼‰
  ONNX_VERSION: "1.20.0"
  ONNXSCRIPT_VERSION: "0.11.0"
  ONNX_SIMPLIFIER_VERSION: "0.4.1"

jobs:
  # åŸºå‡†æµ‹è¯•ä»»åŠ¡ï¼šæ£€æµ‹/åˆ†å‰²æ¨¡å‹æ€§èƒ½ + ONNXå¯¼å‡ºéªŒè¯
  Benchmarks:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11"]  # ä¸å…¨å±€å˜é‡ä¿æŒä¸€è‡´
        model: [yolov5n]
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v6

      # 2. é…ç½®Pythonç¯å¢ƒ
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"  # å¯ç”¨pipç¼“å­˜ï¼ˆå¯é€‰ï¼Œä¸uvç¼“å­˜äºŒé€‰ä¸€ï¼‰

      # 3. å®‰è£…uvåŒ…ç®¡ç†å™¨ï¼ˆç°ä»£PythonåŒ…ç®¡ç†å™¨ï¼‰
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      # 4. ç¼“å­˜uvä¾èµ–ï¼ˆæ ¸å¿ƒï¼šåŠ å¿«ä¾èµ–å®‰è£…é€Ÿåº¦ï¼Œé¿å…é‡å¤ä¸‹è½½ï¼‰
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            **/__pycache__
          key: ${{ matrix.os }}-uv-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ matrix.os }}-uv-

      # 5. ç¼“å­˜æ•°æ®é›†ï¼ˆæ ¸å¿ƒï¼šé¿å…é‡å¤ä¸‹è½½coco128ã€mnist160ç­‰ï¼‰
      - name: Cache datasets
        uses: actions/cache@v4
        with:
          path: datasets/
          key: ${{ matrix.os }}-datasets-${{ hashFiles('**/*.yaml') }}
          restore-keys: |
            ${{ matrix.os }}-datasets-

      # 6. å®‰è£…ä¾èµ–ï¼ˆæ ¸å¿ƒï¼šç§»é™¤æœ‰å®³å‚æ•°ï¼Œæ˜¾å¼å®‰è£…å…¼å®¹ç‰ˆæœ¬ï¼‰
      - name: Install dependencies
        run: |
          # å…³é”®ï¼šç§»é™¤--systemå’Œ--index-strategy unsafe-best-matchï¼ˆé¿å…ä¾èµ–è§£æé”™è¯¯ï¼‰
          # æ˜¾å¼å®‰è£…onnxã€onnxscriptã€onnx-simplifierçš„å…¼å®¹ç‰ˆæœ¬ï¼ˆå¼ºåˆ¶å®‰è£…ï¼Œé¿å…è¢«è·³è¿‡ï¼‰
          uv pip install -U \
            -r requirements.txt \
            coremltools \
            openvino-dev \
            "tensorflow<=2.19.0" \
            onnx==${{ env.ONNX_VERSION }} \
            onnxscript==${{ env.ONNXSCRIPT_VERSION }} \
            onnx-simplifier>=${{ env.ONNX_SIMPLIFIER_VERSION }} \
            --extra-index-url https://download.pytorch.org/whl/cpu

          # å…³é”®éªŒè¯æ­¥éª¤ï¼šç¡®ä¿onnxã€onnxscriptèƒ½æ­£å¸¸å¯¼å…¥ï¼ˆå¤±è´¥æ—¶ç›´æ¥ç»ˆæ­¢CIï¼Œä¾¿äºè°ƒè¯•ï¼‰
          python -c "import onnx, onnxscript, onnxsim; print(f'onnx: {onnx.__version__}'); print(f'onnxscript: {onnxscript.__version__}'); print('âœ… ONNX dependencies imported successfully!')"

          # æ£€æŸ¥ç¯å¢ƒå¹¶åˆ—å‡ºå·²å®‰è£…åŒ…ï¼ˆè°ƒè¯•ç”¨ï¼‰
          yolo checks
          uv pip list

      # 7. åŸºå‡†æµ‹è¯•ï¼šæ£€æµ‹æ¨¡å‹
      - name: Benchmark DetectionModel
        run: |
          python benchmarks.py \
            --data coco128.yaml \
            --weights ${{ matrix.model }}.pt \
            --img ${{ env.IMGSZ_BENCHMARK }} \
            --hard-fail 0.29

      # 8. åŸºå‡†æµ‹è¯•ï¼šåˆ†å‰²æ¨¡å‹
      - name: Benchmark SegmentationModel
        run: |
          python benchmarks.py \
            --data coco128-seg.yaml \
            --weights ${{ matrix.model }}-seg.pt \
            --img ${{ env.IMGSZ_BENCHMARK }} \
            --hard-fail 0.22

      # 9. æµ‹è¯•é¢„æµ‹ï¼šONNXå¯¼å‡º+æ¨ç†
      - name: Test predictions (ONNX)
        run: |
          # å¯¼å‡ºONNXæ ¼å¼
          python export.py --weights ${{ matrix.model }}-cls.pt --include onnx --img 224
          # éªŒè¯æ£€æµ‹/åˆ†å‰²/åˆ†ç±»çš„ONNXæ¨ç†
          python detect.py --weights ${{ matrix.model }}.onnx --img ${{ env.IMGSZ_BENCHMARK }}
          python segment/predict.py --weights ${{ matrix.model }}-seg.onnx --img ${{ env.IMGSZ_BENCHMARK }}
          python classify/predict.py --weights ${{ matrix.model }}-cls.onnx --img 224

      # 10. ä¸Šä¼ åŸºå‡†æµ‹è¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¸Šä¼ ï¼Œä¾¿äºè°ƒè¯•ï¼‰
      - name: Upload Benchmarks artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ${{ matrix.os }}-${{ matrix.python-version }}-benchmarks
          path: |
            runs/
            *.log
          retention-days: 7  # ä¿ç•™7å¤©

  # å…¨åŠŸèƒ½æµ‹è¯•ä»»åŠ¡ï¼šè·¨ç³»ç»Ÿ/Pythonç‰ˆæœ¬çš„æ£€æµ‹/åˆ†å‰²/åˆ†ç±»æµ‹è¯•
  Tests:
    timeout-minutes: 60
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]  # è§„é¿macos-latestçš„bug
        python-version: ["3.11"]
        model: [yolov5n]
        include:
          - os: ubuntu-latest
            python-version: "3.8"  # å…¼å®¹torch 1.8.0ï¼ˆæœ€ä½ç‰ˆæœ¬ï¼‰
            model: [yolov5n]
            torch: "1.8.0"
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v6

      # 2. é…ç½®Pythonç¯å¢ƒ
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      # 3. å®‰è£…uvåŒ…ç®¡ç†å™¨
      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      # 4. ç¼“å­˜uvä¾èµ–
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ matrix.os }}-uv-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ matrix.os }}-uv-${{ matrix.python-version }}-

      # 5. ç¼“å­˜æ•°æ®é›†
      - name: Cache datasets
        uses: actions/cache@v4
        with:
          path: datasets/
          key: ${{ matrix.os }}-datasets-${{ hashFiles('**/*.yaml') }}
          restore-keys: |
            ${{ matrix.os }}-datasets-

      # 6. å®‰è£…ä¾èµ–ï¼ˆæ ¸å¿ƒï¼šå¤„ç†torchæ—§ç‰ˆæœ¬ï¼Œç§»é™¤æœ‰å®³å‚æ•°ï¼‰
      - name: Install dependencies
        shell: bash  # è·¨ç³»ç»Ÿå…¼å®¹
        run: |
          # å¤„ç†torchæ—§ç‰ˆæœ¬ï¼ˆ1.8.0ï¼‰çš„å®‰è£…
          torch_pkgs=""
          if [ "${{ matrix.torch }}" == "1.8.0" ]; then
            # torch 1.8.0çš„cpuç‰ˆæœ¬éœ€è¦æŒ‡å®šæ—§ç´¢å¼•
            torch_pkgs="torch==1.8.0+cpu torchvision==0.9.0+cpu -f https://download.pytorch.org/whl/torch_stable.html"
          fi

          # å…³é”®ï¼šç§»é™¤--systemå’Œ--index-strategy unsafe-best-match
          uv pip install -U \
            -r requirements.txt \
            $torch_pkgs \
            --extra-index-url https://download.pytorch.org/whl/cpu

          # éªŒè¯ç¯å¢ƒ
          yolo checks
          python -m pip list

      # 7. æµ‹è¯•æ£€æµ‹æ¨¡å‹ï¼ˆè®­ç»ƒ/éªŒè¯/æ¨ç†/å¯¼å‡ºï¼‰
      - name: Test detection
        shell: bash
        run: |
          m=${{ matrix.model }}  # å®˜æ–¹æƒé‡
          b=runs/train/exp/weights/best  # è®­ç»ƒåçš„æƒé‡
          # è®­ç»ƒï¼ˆ1 epochï¼Œcpuï¼‰
          python train.py \
            --imgsz ${{ env.IMGSZ_TEST }} \
            --batch ${{ env.BATCH_SIZE_TEST }} \
            --weights $m.pt \
            --cfg $m.yaml \
            --epochs ${{ env.EPOCHS_TEST }} \
            --device cpu
          # éªŒè¯+æ¨ç†ï¼ˆcpuï¼‰
          for d in cpu; do
            for w in $m $b; do
              python val.py --imgsz ${{ env.IMGSZ_TEST }} --batch ${{ env.BATCH_SIZE_TEST }} --weights $w.pt --device $d
              python detect.py --imgsz ${{ env.IMGSZ_TEST }} --weights $w.pt --device $d
            done
          done
          # æµ‹è¯•hubconfã€æ¨¡å‹æ„å»ºã€å¯¼å‡º
          python hubconf.py --model $m
          python models/yolo.py --cfg $m.yaml
          python export.py --weights $m.pt --img ${{ env.IMGSZ_TEST }} --include torchscript
          # æµ‹è¯•torch hubåŠ è½½å’Œjitè¿½è¸ª
          python - <<EOF
          import torch
          im = torch.zeros([1, 3, ${{ env.IMGSZ_TEST }}, ${{ env.IMGSZ_TEST }}])
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path+'.pt', source='local')
              print(model('data/images/bus.jpg'))
              model(im)  # warmup
              torch.jit.trace(model, [im])
          EOF

      # 8. æµ‹è¯•åˆ†å‰²æ¨¡å‹
      - name: Test segmentation
        shell: bash
        run: |
          m=${{ matrix.model }}-seg  # å®˜æ–¹æƒé‡
          b=runs/train-seg/exp/weights/best  # è®­ç»ƒåçš„æƒé‡
          # è®­ç»ƒï¼ˆå¸¦æƒé‡/ç©ºæƒé‡ï¼‰
          python segment/train.py \
            --imgsz ${{ env.IMGSZ_TEST }} \
            --batch ${{ env.BATCH_SIZE_TEST }} \
            --weights $m.pt \
            --cfg $m.yaml \
            --epochs ${{ env.EPOCHS_TEST }} \
            --device cpu
          python segment/train.py \
            --imgsz ${{ env.IMGSZ_TEST }} \
            --batch ${{ env.BATCH_SIZE_TEST }} \
            --weights '' \
            --cfg $m.yaml \
            --epochs ${{ env.EPOCHS_TEST }} \
            --device cpu
          # éªŒè¯+æ¨ç†+å¯¼å‡º
          for d in cpu; do
            for w in $m $b; do
              python segment/val.py --imgsz ${{ env.IMGSZ_TEST }} --batch ${{ env.BATCH_SIZE_TEST }} --weights $w.pt --device $d
              python segment/predict.py --imgsz ${{ env.IMGSZ_TEST }} --weights $w.pt --device $d
              python export.py --weights $w.pt --img ${{ env.IMGSZ_TEST }} --include torchscript --device $d
            done
          done

      # 9. æµ‹è¯•åˆ†ç±»æ¨¡å‹
      - name: Test classification
        shell: bash
        run: |
          m=${{ matrix.model }}-cls.pt  # å®˜æ–¹æƒé‡
          b=runs/train-cls/exp/weights/best.pt  # è®­ç»ƒåçš„æƒé‡
          # è®­ç»ƒ
          python classify/train.py \
            --imgsz 32 \
            --model $m \
            --data mnist160 \
            --epochs ${{ env.EPOCHS_TEST }}
          # éªŒè¯+æ¨ç†
          python classify/val.py --imgsz 32 --weights $b --data ../datasets/mnist160
          python classify/predict.py --imgsz 32 --weights $b --source ../datasets/mnist160/test/7/60.png
          python classify/predict.py --imgsz 32 --weights $m --source data/images/bus.jpg
          # å¯¼å‡º
          python export.py --weights $b --img ${{ env.IMGSZ_TEST }} --include torchscript
          # æµ‹è¯•hubåŠ è½½
          python - <<EOF
          import torch
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
          EOF

      # 10. ä¸Šä¼ æµ‹è¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¸Šä¼ ï¼‰
      - name: Upload Tests artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.torch || 'latest' }}-tests
          path: runs/
          retention-days: 7

  # ç»“æœæ±‡æ€»ï¼šå¤±è´¥æ—¶å‘é€Slacké€šçŸ¥
  Summary:
    runs-on: ubuntu-latest
    needs: [Benchmarks, Tests]
    if: always()  # æ— è®ºå‰åºä»»åŠ¡æ˜¯å¦å¤±è´¥ï¼Œéƒ½è¿è¡Œ
    steps:
      - name: Send Slack notification on failure/cancellation
        if: |
          (needs.Benchmarks.result == 'failure' || needs.Tests.result == 'failure' ||
           needs.Benchmarks.result == 'cancelled' || needs.Tests.result == 'cancelled') &&
          github.repository == 'ultralytics/yolov5' &&
          (github.event_name == 'schedule' || github.event_name == 'push') &&
          github.run_attempt == '1'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_YOLO }}
          payload: |
            {
              "text": "<!channel> GitHub Actions error for ${{ github.workflow }} âŒ\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name }}\n*Benchmarks Result:* ${{ needs.Benchmarks.result }}\n*Tests Result:* ${{ needs.Tests.result }}"
            }
