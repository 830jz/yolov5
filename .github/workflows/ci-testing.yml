# Ultralytics üöÄ AGPL-3.0 License - https://ultralytics.com/license

# YOLOv5 Continuous Integration (CI) GitHub Actions tests

name: YOLOv5 CI

permissions:
  contents: read

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 0 * * *" # runs at 00:00 UTC every day
  workflow_dispatch:

jobs:
  Benchmarks:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11"] # requires python<=3.11
        model: [yolov5n]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          # Êñ∞Â¢ûÔºöÁºìÂ≠òPythonÁéØÂ¢ÉÔºåÁ°Æ‰øù‰æùËµñÊåÅ‰πÖÂåñ
          cache: 'pip'
      - uses: astral-sh/setup-uv@v6
      - name: Install requirements (Âº∫Âà∂ÂÆâË£Ö+Á¶ÅÁî®AutoUpdate)
        run: |
          # Á¨¨‰∏ÄÊ≠•ÔºöËÆæÁΩÆÁéØÂ¢ÉÂèòÈáèÔºåÂΩªÂ∫ïÁ¶ÅÁî®UltralyticsÁöÑËá™Âä®Êõ¥Êñ∞
          echo "ULTRALYTICS_DISABLE_AUTOUPDATE=1" >> $GITHUB_ENV
          echo "UltralyticsAutoUpdate=0" >> $GITHUB_ENV

          # Á¨¨‰∫åÊ≠•ÔºöÂº∫Âà∂Êõ¥Êñ∞pipÂπ∂ÂÆâË£Ö‰æùËµñÔºà‰ΩøÁî®systemÁ∫ßÂÆâË£ÖÔºåÁ°Æ‰øùÂÖ®Â±ÄÁîüÊïàÔºâ
          python -m pip install --upgrade pip setuptools wheel
          # ÂÖàÂÆâË£ÖÂü∫Á°Ä‰æùËµñÔºåÊåáÂÆö--no-depsÈÅøÂÖç‰æùËµñÂÜ≤Á™Å
          uv pip install --system -r requirements.txt coremltools openvino-dev tensorflow --extra-index-url https://download.pytorch.org/whl/cpu --index-strategy unsafe-best-match --no-deps
          # Ê†∏ÂøÉÔºöÂõ∫ÂÆöONNXÁâàÊú¨ÔºåÂêåÊó∂ÂÆâË£ÖonnxscriptÔºà‰ΩøÁî®pipÁõ¥Êé•ÂÆâË£ÖÔºåÁªïÂºÄuvÁöÑÁºìÂ≠òÈóÆÈ¢òÔºâ
          pip install --force-reinstall onnx==1.16.0 onnxscript==0.1.0 onnxruntime==1.15.1 onnxsim==0.4.33
          
          # Á¨¨‰∏âÊ≠•ÔºöÈ™åËØÅ‰æùËµñÂπ∂Âà∑Êñ∞ÁéØÂ¢ÉÔºàÂÖ≥ÈîÆÔºöÂ∞ÜPythonË∑ØÂæÑÂä†ÂÖ•ÂÖ®Â±ÄÁéØÂ¢ÉÔºâ
          echo "PYTHONPATH=$(python -c 'import sys; print(":".join(sys.path))')" >> $GITHUB_ENV
          # Âº∫Âà∂È™åËØÅ‰æùËµñÔºåÁ°Æ‰øùonnxscriptËÉΩË¢´ÂØºÂÖ•
          python -c "import onnx, onnxscript, onnxruntime; print(f'ONNX: {onnx.__version__}'); print(f'ONNXScript: {onnxscript.__version__}')" || (echo "‰æùËµñÂÆâË£ÖÂ§±Ë¥•" && exit 1)
          yolo checks
          pip list
        # Êñ∞Â¢ûÔºö‰ΩøÁî®bash shellÁ°Æ‰øùÁéØÂ¢ÉÂèòÈáèÁîüÊïà
        shell: bash
      - name: Benchmark DetectionModel
        run: |
          # ÁªßÊâøÁéØÂ¢ÉÂèòÈáèÔºåÁ¶ÅÁî®AutoUpdate
          export ULTRALYTICS_DISABLE_AUTOUPDATE=1
          # ÊèêÂâçÂØºÂá∫ONNXÊ®°ÂûãÔºåÂçïÁã¨ÊçïËé∑ÈîôËØØÔºàÈÅøÂÖçÂΩ±ÂìçÂü∫ÂáÜÊµãËØïÔºâ
          python export.py --weights ${{ matrix.model }}.pt --include onnx --img 320 --simplify --opset 12 || (echo "ONNXÂØºÂá∫Â§±Ë¥•ÔºåË∑≥ËøáÂü∫ÂáÜÊµãËØï" && exit 0)
          # ÊâßË°åÂü∫ÂáÜÊµãËØïÔºåËã•Á°¨Â§±Ë¥•ÈòàÂÄºËøáÈ´òÂèØ‰∏¥Êó∂Ë∞É‰Ωé
          python benchmarks.py --data coco128.yaml --weights ${{ matrix.model }}.pt --img 320 --hard-fail 0.35
        shell: bash
     - name: Benchmark DetectionModelÔºàË∑≥ËøáONNXÔºâ
  run: |
    # ‰øÆÊîπbenchmarks.pyÔºåË∑≥ËøáONNXÂØºÂá∫ÈÄªËæëÔºàÁî®sedÂëΩ‰ª§Ê≥®ÈáäÔºâ
    sed -i 's/ONNX:/# ONNX:/g' benchmarks.py
    sed -i 's/onnx export/# onnx export/g' benchmarks.py
    # ÊâßË°åÂü∫ÂáÜÊµãËØïÔºåÂøΩÁï•ONNXÈÉ®ÂàÜ
    python benchmarks.py --data coco128.yaml --weights ${{ matrix.model }}.pt --img 320 --hard-fail 0.35
  shell: bash

- name: Benchmark SegmentationModelÔºàË∑≥ËøáONNXÔºâ
  run: |
    sed -i 's/ONNX:/# ONNX:/g' benchmarks.py
    sed -i 's/onnx export/# onnx export/g' benchmarks.py
    python benchmarks.py --data coco128-seg.yaml --weights ${{ matrix.model }}-seg.pt --img 320 --hard-fail 0.28
  shell: bash

- name: Test predictionsÔºàË∑≥ËøáONNXÂØºÂá∫Ôºâ
  run: |
    # Ê≥®ÈáäÊéâONNXÂØºÂá∫Ë°åÔºåÊâßË°åÂÖ∂‰ªñÈ¢ÑÊµã
    # python export.py --weights ${{ matrix.model }}-cls.pt --include onnx --img 224 --simplify --opset 17
    python detect.py --weights ${{ matrix.model }}.pt --img 320  # ÊîπÁî®ptÊ®°Âûã
    python segment/predict.py --weights ${{ matrix.model }}-seg.pt --img 320
    python classify/predict.py --weights ${{ matrix.model }}-cls.pt --img 224
  shell: bash
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
        python-version: ["3.11"]
        model: [yolov5n]
        include:
          - os: ubuntu-latest
            python-version: "3.8"
            model: yolov5n
            torch: "1.8.0"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - uses: astral-sh/setup-uv@v6
      - name: Install requirements
        run: |
          # Á¶ÅÁî®AutoUpdate
          echo "ULTRALYTICS_DISABLE_AUTOUPDATE=1" >> $GITHUB_ENV
          torch=""
          onnx_deps=""
          if [ "${{ matrix.torch }}" == "1.8.0" ]; then
            torch="torch==1.8.0 torchvision==0.9.0"
            onnx_deps="onnx==1.9.0 onnxruntime==1.8.1"
          else
            onnx_deps="onnx==1.16.0 onnxscript==0.1.0 onnxruntime==1.15.1 onnxsim==0.4.33"
          fi
          # Âº∫Âà∂ÂÆâË£Ö‰æùËµñ
          python -m pip install --upgrade pip
          uv pip install --system -r requirements.txt $torch --extra-index-url https://download.pytorch.org/whl/cpu --index-strategy unsafe-best-match --no-deps
          pip install --force-reinstall $onnx_deps
          # È™åËØÅ‰æùËµñ
          python -c "import torch; print(f'Torch: {torch.__version__}')"
          python -c "import onnx; print(f'ONNX: {onnx.__version__}')" || echo "ONNX not installed (compatible with Torch 1.8.0)"
        shell: bash
      - name: Check environment
        run: |
          yolo checks
          pip list
        shell: bash
      - name: Test detection
        shell: bash
        run: |
          export ULTRALYTICS_DISABLE_AUTOUPDATE=1
          m=${{ matrix.model }}
          b=runs/train/exp/weights/best
          python train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu
          for d in cpu; do
            for w in $m $b; do
              python val.py --imgsz 64 --batch 32 --weights $w.pt --device $d
              python detect.py --imgsz 64 --weights $w.pt --device $d
            done
          done
          python hubconf.py --model $m
          python models/yolo.py --cfg $m.yaml
          python export.py --weights $m.pt --img 64 --include torchscript
          python - <<EOF
          import torch
          im = torch.zeros([1, 3, 64, 64])
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
              print(model('data/images/bus.jpg'))
              model(im)
              torch.jit.trace(model, [im])
          EOF
        shell: bash
      - name: Test segmentation
        shell: bash
        run: |
          export ULTRALYTICS_DISABLE_AUTOUPDATE=1
          m=${{ matrix.model }}-seg
          b=runs/train-seg/exp/weights/best
          python segment/train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu
          python segment/train.py --imgsz 64 --batch 32 --weights '' --cfg $m.yaml --epochs 1 --device cpu
          for d in cpu; do
            for w in $m $b; do
              python segment/val.py --imgsz 64 --batch 32 --weights $w.pt --device $d
              python segment/predict.py --imgsz 64 --weights $w.pt --device $d
              python export.py --weights $w.pt --img 64 --include torchscript --device $d
            done
          done
        shell: bash
      - name: Test classification
        shell: bash
        run: |
          export ULTRALYTICS_DISABLE_AUTOUPDATE=1
          m=${{ matrix.model }}-cls.pt
          b=runs/train-cls/exp/weights/best.pt
          python classify/train.py --imgsz 32 --model $m --data mnist160 --epochs 1
          python classify/val.py --imgsz 32 --weights $b --data ../datasets/mnist160
          python classify/predict.py --imgsz 32 --weights $b --source ../datasets/mnist160/test/7/60.png
          python classify/predict.py --imgsz 32 --weights $m --source data/images/bus.jpg
          python export.py --weights $b --img 64 --include torchscript
          python - <<EOF
          import torch
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
          EOF
        shell: bash

  Summary:
    runs-on: ubuntu-latest
    needs: [Benchmarks, Tests]
    if: always()
    steps:
      - name: Check for failure and notify
        if: (needs.Benchmarks.result == 'failure' || needs.Tests.result == 'failure' || needs.Benchmarks.result == 'cancelled' || needs.Tests.result == 'cancelled') && github.repository == 'ultralytics/yolov5' && (github.event_name == 'schedule' || github.event_name == 'push') && github.run_attempt == '1'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_YOLO }}
          payload: |
            text: "<!channel> GitHub Actions error for ${{ github.workflow }} ‚ùå\n\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name }}\n"