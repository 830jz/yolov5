# Ultralytics üöÄ AGPL-3.0 License - https://ultralytics.com/license

# YOLOv5 Continuous Integration (CI) GitHub Actions tests

name: YOLOv5 CI

permissions:
  contents: read

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 0 * * *" # runs at 00:00 UTC every day
  workflow_dispatch:

jobs:
  Benchmarks:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11"] # requires python<=3.11
        model: [yolov5n]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip' # ÂêØÁî®pipÁºìÂ≠òÔºå‰ΩÜÊú¨Ê¨°‰ºöÂº∫Âà∂Ê∏ÖÁêÜ
      - uses: astral-sh/setup-uv@v6

      # ÂÖ≥ÈîÆÊ≠•È™§1ÔºöÂÆâË£ÖÁ≥ªÁªüÁ∫ß‰æùËµñÔºàËß£ÂÜ≥ONNXÂÆâË£ÖÁöÑÂ∫ïÂ±Ç‰æùËµñÁº∫Â§±ÔºåÊØîÂ¶ÇlibprotobufÔºâ
      - name: Install system dependencies for ONNX (ÂÖúÂ∫ï)
        run: |
          sudo apt-get update && sudo apt-get install -y libprotobuf-dev protobuf-compiler
        shell: bash

      # ÂÖ≥ÈîÆÊ≠•È™§2ÔºöÂΩªÂ∫ï‰øÆÊîπbenchmarks.pyÔºåÂà†Èô§ONNXÁõ∏ÂÖ≥ÁöÑÊâÄÊúâÈÄªËæë
      - name: Remove ONNX benchmark logic from benchmarks.py
        run: |
          # ÊñπÊ≥ï1ÔºöÁî®sedÂëΩ‰ª§Âà†Èô§ONNXÁõ∏ÂÖ≥ÁöÑ‰ª£Á†ÅÂùóÔºàÁ≤æÂáÜÂåπÈÖçÔºâ
          # ÂåπÈÖçÂåÖÂê´"ONNX:"ÁöÑË°åÂπ∂Ê≥®Èáä/Âà†Èô§
          sed -i '/ONNX:/d' benchmarks.py
          # ÂåπÈÖçÂåÖÂê´"onnx"ÁöÑÂØºÂá∫Áõ∏ÂÖ≥Ë°åÂπ∂Âà†Èô§
          sed -i '/onnx export/d' benchmarks.py
          sed -i '/export.run.*onnx/d' benchmarks.py
          # ÊñπÊ≥ï2ÔºöÁõ¥Êé•ÊõøÊç¢benchmarks.py‰∏≠ÁöÑÂØºÂá∫ÈÄªËæëÔºåÂè™‰øùÁïôPyTorchÔºàÂΩªÂ∫ïÊùúÁªùÔºâ
          # Â¶ÇÊûú‰Ω†ËÉΩÁ°ÆÂÆöbenchmarks.py‰∏≠ÂØºÂá∫ÁöÑÈÉ®ÂàÜÔºå‰πüÂèØ‰ª•Áî®Ëøô‰∏™Êõ¥Êö¥ÂäõÁöÑÊñπÂºè
          python -c "
          import fileinput
          import re
          for line in fileinput.input('benchmarks.py', inplace=True):
              # ÁßªÈô§ÊâÄÊúâÂåÖÂê´ONNX/onnxÁöÑË°å
              if not re.search(r'ONNX|onnx', line, re.IGNORECASE):
                  print(line, end='')
          "
        shell: bash

      - name: Install requirements
        run: |
          # Âº∫Âà∂Ê∏ÖÁêÜÊóß‰æùËµñÁºìÂ≠ò
          pip cache purge
          # ÂçáÁ∫ßpipÂπ∂ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
          python -m pip install --upgrade pip setuptools wheel
          uv pip install --system -r requirements.txt coremltools openvino-dev tensorflow --extra-index-url https://download.pytorch.org/whl/cpu --index-strategy unsafe-best-match
          # ‰ªÖÂÆâË£ÖÂøÖË¶ÅÁöÑ‰æùËµñÔºå‰∏çÂÜçÂº∫Âà∂ÂÆâË£ÖONNXÔºàÂõ†‰∏∫Â∑≤ÁªèÁßªÈô§Áõ∏ÂÖ≥ÈÄªËæëÔºâ
          pip install onnxruntime==1.17.0 onnxsim==0.4.33 || echo "ONNX optional dependencies not installed"
          # È™åËØÅÁéØÂ¢É
          yolo checks
          pip list
        shell: bash

      - name: Benchmark DetectionModel (Êó†ONNXÈÄªËæë)
        run: |
          # ÊâßË°åÂü∫ÂáÜÊµãËØïÔºåÊ≠§Êó∂Â∑≤Êó†ONNXÁõ∏ÂÖ≥‰ª£Á†Å
          python benchmarks.py --data coco128.yaml --weights ${{ matrix.model }}.pt --img 320 --hard-fail 0.29
        shell: bash

      - name: Benchmark SegmentationModel (Êó†ONNXÈÄªËæë)
        run: |
          python benchmarks.py --data coco128-seg.yaml --weights ${{ matrix.model }}-seg.pt --img 320 --hard-fail 0.22
        shell: bash

      - name: Test predictions (ÊîπÁî®PyTorchÊ®°ÂûãÔºåË∑≥ËøáONNXÂØºÂá∫)
        run: |
          # Ê≥®ÈáäÊéâONNXÂØºÂá∫Ë°åÔºåÁõ¥Êé•‰ΩøÁî®PTÊ®°ÂûãËøõË°åÈ¢ÑÊµã
          # python export.py --weights ${{ matrix.model }}-cls.pt --include onnx --img 224
          python detect.py --weights ${{ matrix.model }}.pt --img 320  # ÊîπÁî®.ptÊ®°Âûã
          python segment/predict.py --weights ${{ matrix.model }}-seg.pt --img 320  # ÊîπÁî®.ptÊ®°Âûã
          python classify/predict.py --weights ${{ matrix.model }}-cls.pt --img 224  # ÊîπÁî®.ptÊ®°Âûã
        shell: bash

  Tests:
    timeout-minutes: 60
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
        python-version: ["3.11"]
        model: [yolov5n]
        include:
          - os: ubuntu-latest
            python-version: "3.8"
            model: yolov5n
            torch: "1.8.0"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - uses: astral-sh/setup-uv@v6

      - name: Install system dependencies (for Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update && sudo apt-get install -y libprotobuf-dev protobuf-compiler
        shell: bash

      - name: Install requirements
        run: |
          torch=""
          if [ "${{ matrix.torch }}" == "1.8.0" ]; then
            torch="torch==1.8.0 torchvision==0.9.0"
          fi
          # Ê∏ÖÁêÜÁºìÂ≠òÂêéÂÆâË£Ö
          pip cache purge
          uv pip install --system -r requirements.txt $torch --extra-index-url https://download.pytorch.org/whl/cpu --index-strategy unsafe-best-match
          # ÂèØÈÄâÔºöÂÆâË£ÖËΩªÈáè‰æùËµñÔºå‰∏çÂº∫Âà∂ONNX
          pip install onnxruntime==1.17.0 || echo "ONNX runtime not installed"
        shell: bash

      - name: Check environment
        run: |
          yolo checks
          pip list
        shell: bash

      - name: Test detection (Ë∑≥ËøáONNXÂØºÂá∫Ôºå‰ªÖÁî®TorchScript)
        shell: bash
        run: |
          m=${{ matrix.model }}
          b=runs/train/exp/weights/best
          python train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu
          for d in cpu; do
            for w in $m $b; do
              python val.py --imgsz 64 --batch 32 --weights $w.pt --device $d
              python detect.py --imgsz 64 --weights $w.pt --device $d
            done
          done
          python hubconf.py --model $m
          python models/yolo.py --cfg $m.yaml
          # ‰ªÖÂØºÂá∫TorchScriptÔºåË∑≥ËøáONNX
          python export.py --weights $m.pt --img 64 --include torchscript
          python - <<EOF
          import torch
          im = torch.zeros([1, 3, 64, 64])
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
              print(model('data/images/bus.jpg'))
              model(im)
              torch.jit.trace(model, [im])
          EOF

      - name: Test segmentation (Ë∑≥ËøáONNXÂØºÂá∫)
        shell: bash
        run: |
          m=${{ matrix.model }}-seg
          b=runs/train-seg/exp/weights/best
          python segment/train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu
          python segment/train.py --imgsz 64 --batch 32 --weights '' --cfg $m.yaml --epochs 1 --device cpu
          for d in cpu; do
            for w in $m $b; do
              python segment/val.py --imgsz 64 --batch 32 --weights $w.pt --device $d
              python segment/predict.py --imgsz 64 --weights $w.pt --device $d
              # ‰ªÖÂØºÂá∫TorchScript
              python export.py --weights $w.pt --img 64 --include torchscript --device $d
            done
          done

      - name: Test classification (Ë∑≥ËøáONNXÂØºÂá∫)
        shell: bash
        run: |
          m=${{ matrix.model }}-cls.pt
          b=runs/train-cls/exp/weights/best.pt
          python classify/train.py --imgsz 32 --model $m --data mnist160 --epochs 1
          python classify/val.py --imgsz 32 --weights $b --data ../datasets/mnist160
          python classify/predict.py --imgsz 32 --weights $b --source ../datasets/mnist160/test/7/60.png
          python classify/predict.py --imgsz 32 --weights $m --source data/images/bus.jpg
          # ‰ªÖÂØºÂá∫TorchScript
          python export.py --weights $b --img 64 --include torchscript
          python - <<EOF
          import torch
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
          EOF

  Summary:
    runs-on: ubuntu-latest
    needs: [Benchmarks, Tests]
    if: always()
    steps:
      - name: Check for failure and notify
        if: (needs.Benchmarks.result == 'failure' || needs.Tests.result == 'failure' || needs.Benchmarks.result == 'cancelled' || needs.Tests.result == 'cancelled') && github.repository == 'ultralytics/yolov5' && (github.event_name == 'schedule' || github.event_name == 'push') && github.run_attempt == '1'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_YOLO }}
          payload: |
            text: "<!channel> GitHub Actions error for ${{ github.workflow }} ‚ùå\n\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name }}\n"