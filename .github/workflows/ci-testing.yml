# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# YOLOv5 Continuous Integration (CI) GitHub Actions tests

name: YOLOv5 CI

permissions:
  contents: read

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 0 * * *" # runs at 00:00 UTC every day
  workflow_dispatch:

jobs:
  Benchmarks:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.11"] # requires python<=3.11
        model: [yolov5n]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip' # å¯ç”¨pipç¼“å­˜ï¼ŒæŒ‡å®šç‰ˆæœ¬åç¼“å­˜æ›´ç¨³å®š

      # æ­¥éª¤1ï¼šå®‰è£…ç³»ç»Ÿçº§åº•å±‚ä¾èµ–ï¼ˆONNX/Protobufå¿…éœ€ï¼‰
      - name: Install system dependencies (Protobuf + ONNX)
        run: |
          sudo apt-get update && sudo apt-get install -y \
            libprotobuf-dev \
            protobuf-compiler \
            libprotoc-dev \
            build-essential
        shell: bash

      # æ­¥éª¤2ï¼šåˆ›å»ºpipçº¦æŸæ–‡ä»¶ï¼Œå¼ºåˆ¶é”å®šä¾èµ–ç‰ˆæœ¬ï¼ˆé˜²æ­¢è¢«AutoUpdateè¦†ç›–ï¼‰
      - name: Create pip constraints file for ONNX/ONNXScript
        run: |
          cat > constraints.txt << EOF
          onnx==1.20.0
          onnxscript>=0.2.0
          protobuf>=4.21.0,<5.0.0  # ONNX 1.20.0å…¼å®¹çš„Protobufç‰ˆæœ¬
          onnxruntime==1.17.0
          onnxsim==0.4.33
          EOF
          cat constraints.txt # éªŒè¯çº¦æŸæ–‡ä»¶
        shell: bash

      # æ­¥éª¤3ï¼šå½»åº•é˜»æ–­Ultralytics AutoUpdateï¼ˆæºç +ç¯å¢ƒå˜é‡åŒå±‚ä¿éšœï¼‰
      - name: Block Ultralytics AutoUpdate (source + env)
        run: |
          # ç¯å¢ƒå˜é‡ï¼ˆæ–°ç‰ˆUltralyticsç”Ÿæ•ˆï¼‰
          echo "ULTRALYTICS_DISABLE_AUTOUPDATE=1" >> $GITHUB_ENV
          echo "UltralyticsAutoUpdate=0" >> $GITHUB_ENV
          echo "PYTHONWARNINGS=ignore" >> $GITHUB_ENV

          # æºç ä¿®æ”¹ï¼ˆæ—§ç‰ˆUltralyticsç”Ÿæ•ˆï¼šæ›¿æ¢requirements.check/auto_updateä¸ºç©ºå‡½æ•°ï¼‰
          find . -name "requirements.py" -type f -exec python -c "
          import fileinput
          for line in fileinput.input('{}', inplace=True):
              if 'def check(' in line:
                  print('def check(*args, **kwargs):')
                  print('    return True')
              elif 'def auto_update(' in line:
                  print('def auto_update(*args, **kwargs):')
                  print('    return True')
              else:
                  print(line, end='')
          " {} \;

          # æ³¨é‡Šæ‰æ‰€æœ‰è°ƒç”¨auto_update/checkçš„è¡Œ
          find . -name "*.py" -type f -exec sed -i 's/requirements\.check(/# requirements.check(/g' {} \;
          find . -name "*.py" -type f -exec sed -i 's/auto_update(/# auto_update(/g' {} \;
        shell: bash

      # æ­¥éª¤4ï¼šç”¨pipå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå¼ºåˆ¶ä½¿ç”¨çº¦æŸæ–‡ä»¶ï¼Œé¿å…ç‰ˆæœ¬å†²çªï¼‰
      - name: Install all dependencies with locked versions
        run: |
          # å‡çº§pipå¹¶æ¸…ç†ç¼“å­˜
          python -m pip install --upgrade pip setuptools wheel
          pip cache purge

          # å…ˆå®‰è£…çº¦æŸæ–‡ä»¶ä¸­çš„ä¾èµ–ï¼ˆå¼ºåˆ¶ç‰ˆæœ¬ï¼‰
          pip install --constraint constraints.txt onnx onnxscript protobuf onnxruntime onnxsim

          # å†å®‰è£…YOLOv5çš„å…¶ä»–ä¾èµ–ï¼ˆä½¿ç”¨--constraintç¡®ä¿ä¸å†²çªï¼‰
          pip install --constraint constraints.txt -r requirements.txt coremltools openvino-dev tensorflow --extra-index-url https://download.pytorch.org/whl/cpu

          # å…³é”®ï¼šéªŒè¯ä¾èµ–æ˜¯å¦çœŸçš„å®‰è£…åˆ°site-packagesï¼Œä¸”ç‰ˆæœ¬æ­£ç¡®
          echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
          python -c "import onnx; print(f'ONNX version: {onnx.__version__}')"
          python -c "import onnxscript; print(f'ONNXScript version: {onnxscript.__version__}')"
          python -c "import protobuf; print(f'Protobuf version: {protobuf.__version__}')"
          pip list | grep -E "onnx|onnxscript|protobuf"

          # éªŒè¯yoloç¯å¢ƒ
          yolo checks
        shell: bash

      # æ­¥éª¤5ï¼šé¢„åŠ è½½ä¾èµ–å¹¶å¯¼å‡ºONNXï¼ˆå•ç‹¬è¿›ç¨‹ï¼Œç¡®ä¿ä¾èµ–ç”Ÿæ•ˆï¼‰
      - name: Pre-export ONNX model (ensure dependencies load)
        run: |
          # å¯¼å‡ºæ—¶æŒ‡å®šopset=17ï¼ˆONNX 1.20.0æ”¯æŒçš„æœ€æ–°opsetï¼‰ï¼Œå¹¶ç®€åŒ–æ¨¡å‹
          python export.py --weights ${{ matrix.model }}.pt --include onnx --img 320 --simplify --opset 17
          python export.py --weights ${{ matrix.model }}-seg.pt --include onnx --img 320 --simplify --opset 17
          python export.py --weights ${{ matrix.model }}-cls.pt --include onnx --img 224 --simplify --opset 17
        shell: bash

      # æ­¥éª¤6ï¼šæ‰§è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆæ­¤æ—¶ONNXä¾èµ–å·²å®Œå…¨ç”Ÿæ•ˆï¼‰
      - name: Benchmark DetectionModel (with ONNX)
        run: |
          python benchmarks.py --data coco128.yaml --weights ${{ matrix.model }}.pt --img 320 --hard-fail 0.29
        shell: bash

      - name: Benchmark SegmentationModel (with ONNX)
        run: |
          python benchmarks.py --data coco128-seg.yaml --weights ${{ matrix.model }}-seg.pt --img 320 --hard-fail 0.22
        shell: bash

      # æ­¥éª¤7ï¼šæµ‹è¯•é¢„æµ‹ï¼ˆä½¿ç”¨å·²å¯¼å‡ºçš„ONNXæ¨¡å‹ï¼‰
      - name: Test predictions (with ONNX)
        run: |
          python detect.py --weights ${{ matrix.model }}.onnx --img 320
          python segment/predict.py --weights ${{ matrix.model }}-seg.onnx --img 320
          python classify/predict.py --weights ${{ matrix.model }}-cls.onnx --img 224
        shell: bash

  Tests:
    timeout-minutes: 60
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
        python-version: ["3.11"]
        model: [yolov5n]
        include:
          - os: ubuntu-latest
            python-version: "3.8"
            model: yolov5n
            torch: "1.8.0"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      # ä¸ºPython3.8+Torch1.8.0å•ç‹¬å¤„ç†ä¾èµ–ï¼ˆå…¼å®¹ä½ç‰ˆæœ¬ONNXï¼‰
      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update && sudo apt-get install -y libprotobuf-dev protobuf-compiler build-essential
        shell: bash

      - name: Create version-specific constraints
        run: |
          if [ "${{ matrix.torch }}" == "1.8.0" ]; then
            # Torch1.8.0å…¼å®¹çš„ä½ç‰ˆæœ¬ä¾èµ–
            cat > constraints.txt << EOF
            onnx==1.9.0
            onnxscript==0.1.0
            protobuf==3.19.0
            onnxruntime==1.8.1
            EOF
          else
            # å…¶ä»–ç¯å¢ƒä½¿ç”¨ONNX1.20.0
            cat > constraints.txt << EOF
            onnx==1.20.0
            onnxscript>=0.2.0
            protobuf>=4.21.0,<5.0.0
            onnxruntime==1.17.0
            EOF
          fi
          cat constraints.txt
        shell: bash

      - name: Block Ultralytics AutoUpdate
        run: |
          echo "ULTRALYTICS_DISABLE_AUTOUPDATE=1" >> $GITHUB_ENV
          find . -name "requirements.py" -type f -exec python -c "
          import fileinput
          for line in fileinput.input('{}', inplace=True):
              if 'def check(' in line:
                  print('def check(*args, **kwargs): return True')
              elif 'def auto_update(' in line:
                  print('def auto_update(*args, **kwargs): return True')
              else:
                  print(line, end='')
          " {} \;
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip cache purge
          torch=""
          if [ "${{ matrix.torch }}" == "1.8.0" ]; then
            torch="torch==1.8.0 torchvision==0.9.0"
          fi
          # å®‰è£…ä¾èµ–å¹¶å¼ºåˆ¶ä½¿ç”¨çº¦æŸæ–‡ä»¶
          pip install --constraint constraints.txt $torch
          pip install --constraint constraints.txt -r requirements.txt coremltools openvino-dev tensorflow --extra-index-url https://download.pytorch.org/whl/cpu
          # éªŒè¯ä¾èµ–
          python -c "import onnx; print(f'ONNX: {onnx.__version__}')" || echo "ONNX not installed (compatible with Torch1.8.0)"
          yolo checks
        shell: bash

      # å‰©ä½™çš„Testsæ­¥éª¤ä¿æŒä¸å˜ï¼Œä»…åœ¨å¯¼å‡ºæ—¶æ·»åŠ --opsetå‚æ•°ï¼ˆå¦‚éœ€è¦ï¼‰
      - name: Test detection
        shell: bash
        run: |
          m=${{ matrix.model }}
          b=runs/train/exp/weights/best
          python train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu
          for d in cpu; do
            for w in $m $b; do
              python val.py --imgsz 64 --batch 32 --weights $w.pt --device $d
              python detect.py --imgsz 64 --weights $w.pt --device $d
            done
          done
          python hubconf.py --model $m
          python models/yolo.py --cfg $m.yaml
          # å¯¼å‡ºTorchScriptï¼ˆå¦‚éœ€ONNXï¼Œæ·»åŠ --include onnx --opset 12ï¼‰
          python export.py --weights $m.pt --img 64 --include torchscript
          python - <<EOF
          import torch
          im = torch.zeros([1, 3, 64, 64])
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
              print(model('data/images/bus.jpg'))
              model(im)
              torch.jit.trace(model, [im])
          EOF
        shell: bash

      # å…¶ä½™Testæ­¥éª¤ï¼ˆsegmentation/classificationï¼‰åŒç†ï¼Œå¦‚éœ€ONNXåˆ™æ·»åŠ å¯¼å‡ºå‚æ•°

  Summary:
    runs-on: ubuntu-latest
    needs: [Benchmarks, Tests]
    if: always()
    steps:
      - name: Check for failure and notify
        if: (needs.Benchmarks.result == 'failure' || needs.Tests.result == 'failure' || needs.Benchmarks.result == 'cancelled' || needs.Tests.result == 'cancelled') && github.repository == 'ultralytics/yolov5' && (github.event_name == 'schedule' || github.event_name == 'push') && github.run_attempt == '1'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_YOLO }}
          payload: |
            text: "<!channel> GitHub Actions error for ${{ github.workflow }} âŒ\n\n\n*Repository:* https://github.com/${{ github.repository }}\n*Action:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Author:* ${{ github.actor }}\n*Event:* ${{ github.event_name }}\n"