# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Continuous Integration (CI) GitHub Actions tests broken link checker using https://github.com/lycheeverse/lychee
# Ignores the following status codes to reduce false positives:
#   - 403(OpenVINO, 'forbidden')
#   - 429(Instagram, 'too many requests')
#   - 500(Zenodo, 'cached')
#   - 502(Zenodo, 'bad gateway')
#   - 999(LinkedIn, 'unknown status code')

name: Check Broken links

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # runs at 00:00 UTC every day

jobs:
  Links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download and install lychee
        run: |
          LYCHEE_URL=$(curl -s https://api.github.com/repos/lycheeverse/lychee/releases/latest | grep "browser_download_url" | grep "x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4)
          curl -L $LYCHEE_URL | tar xz -C /usr/local/bin
          # éªŒè¯lycheeå®‰è£…æˆåŠŸ
          lychee --version

      - name: Test Markdown and HTML links with retry
        uses: ultralytics/actions/retry@main
        with:
          timeout_minutes: 5
          retry_delay_seconds: 60
          retries: 2
          run: |
            # 1. å¼€å¯globstarï¼ˆæ”¯æŒ**é€’å½’åŒ¹é…ï¼‰+ pipefailï¼ˆä¿ç•™ç®¡é“ä¸­ç¬¬ä¸€ä¸ªé”™è¯¯çš„é€€å‡ºç ï¼‰
            shopt -s globstar
            set -o pipefail
            # 2. æ‰§è¡Œlycheeï¼ˆä¿®æ­£ç»­è¡Œç¬¦ã€æ­£åˆ™ã€å¼•å·é—®é¢˜ï¼‰
            lychee \
              --scheme https \
              --timeout 60 \
              --insecure \
              --accept 100..=103,200..=299,401,403,429,500,502,999 \
              --exclude-all-private \
              --regex \ # å…³é”®ï¼šæ·»åŠ --regexï¼Œè®©lycheeè§£ææ­£åˆ™è¡¨è¾¾å¼
              --exclude "https?://(www\.)?(linkedin\.com|twitter\.com|x\.com|instagram\.com|kaggle\.com|fonts\.gstatic\.com|url\.com)" \
              --exclude-path "**/ci.yaml" \
              --github-token ${{ secrets.GITHUB_TOKEN }} \
              --header "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.183 Safari/537.36" \
              ./**/*.md \ # å»æ‰å•å¼•å·ï¼Œè®©globç”Ÿæ•ˆ
              ./**/*.html | tee -a $GITHUB_STEP_SUMMARY

            # 3. æ£€æŸ¥lycheeè¾“å‡ºï¼ˆå…¼å®¹0 error(s)/0 Errors/0 errorsï¼‰
            if ! grep -qi "0 error(s)\|0 Errors\|0 errors" "$GITHUB_STEP_SUMMARY"; then
              exit 1
            fi

      - name: Test Markdown, HTML, YAML, Python and Notebook links with retry
        if: github.event_name == 'workflow_dispatch'
        uses: ultralytics/actions/retry@main
        with:
          timeout_minutes: 5
          retry_delay_seconds: 60
          retries: 2
          run: |
            # 1. å¼€å¯globstar + pipefail
            shopt -s globstar
            set -o pipefail
            # 2. æ‰§è¡Œlycheeï¼ˆä¿®æ­£åŒä¸Šï¼‰
            lychee \
              --scheme https \
              --timeout 60 \
              --insecure \
              --accept 100..=103,200..=299,429,999 \
              --exclude-all-private \
              --regex \
              --exclude "https?://(www\.)?(linkedin\.com|twitter\.com|x\.com|instagram\.com|kaggle\.com|fonts\.gstatic\.com|url\.com)" \
              --exclude-path "**/ci.yaml" \
              --github-token ${{ secrets.GITHUB_TOKEN }} \
              --header "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.183 Safari/537.36" \
              ./**/*.md \
              ./**/*.html \
              ./**/*.yml \
              ./**/*.yaml \
              ./**/*.py \
              ./**/*.ipynb | tee -a $GITHUB_STEP_SUMMARY

            # 3. æ£€æŸ¥lycheeè¾“å‡º
            if ! grep -qi "0 error(s)\|0 Errors\|0 errors" "$GITHUB_STEP_SUMMARY"; then
              exit 1
            fi
