# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Continuous Integration (CI) GitHub Actions tests broken link checker using https://github.com/lycheeverse/lychee
# Ignores the following status codes to reduce false positives:
#   - 403(OpenVINO, 'forbidden')
#   - 429(Instagram, 'too many requests')
#   - 500(Zenodo, 'cached')
#   - 502(Zenodo, 'bad gateway')
#   - 999(LinkedIn, 'unknown status code')

name: Check Broken links

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # runs at 00:00 UTC every day

jobs:
  Links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download and install lychee
        run: |
          # ä¸‹è½½æœ€æ–°ç‰ˆlycheeé¢„ç¼–è¯‘åŒ…
          LYCHEE_URL=$(curl -s https://api.github.com/repos/lycheeverse/lychee/releases/latest | grep "browser_download_url" | grep "x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4)
          curl -L $LYCHEE_URL | tar xz -C /usr/local/bin
          # éªŒè¯å®‰è£…å¹¶æŸ¥çœ‹ç‰ˆæœ¬å’Œå¸®åŠ©ï¼ˆå…³é”®ï¼šç¡®è®¤å‚æ•°æ˜¯å¦å­˜åœ¨ï¼‰
          lychee --version
          lychee --help | grep -E "exclude|scheme|accept" # æŸ¥çœ‹æ ¸å¿ƒå‚æ•°è¯´æ˜

      - name: Test Markdown and HTML links with retry
        uses: ultralytics/actions/retry@main
        with:
          timeout_minutes: 5
          retry_delay_seconds: 60
          retries: 2
          run: |
            # 1. å…³é”®é…ç½®ï¼šå¼€å¯é€’å½’é€šé…ç¬¦ + ä¿ç•™ç®¡é“é”™è¯¯ç  + ä¸è‡ªåŠ¨é€€å‡ºï¼ˆå…¼å®¹é‡è¯•é€»è¾‘ï¼‰
            shopt -s globstar  # è®©**é€’å½’åŒ¹é…å­ç›®å½•
            set -o pipefail    # ç®¡é“ä¸­ä»»æ„å‘½ä»¤å¤±è´¥åˆ™è¿”å›å¯¹åº”é€€å‡ºç 
            set +e             # é…åˆé‡è¯•é€»è¾‘ï¼Œä¸ç«‹å³é€€å‡º

            # 2. æ‰§è¡Œlycheeï¼ˆæ ¸å¿ƒï¼šç§»é™¤--regexï¼Œæ”¹ç”¨globæ¨¡å¼çš„--excludeï¼‰
            lychee \
              --scheme https \
              --timeout 60 \
              --insecure \
              --accept 100..=103,200..=299,401,403,429,500,502,999 \
              --exclude-all-private \
              # æ–¹å¼1ï¼šç”¨,åˆ†éš”å¤šä¸ªglobè§„åˆ™ï¼ˆæ¨èï¼Œç®€æ´ï¼‰
              --exclude "https://*.linkedin.com,https://*.twitter.com,https://*.x.com,https://*.instagram.com,https://*.kaggle.com,https://*.fonts.gstatic.com,https://*.url.com,http://*.linkedin.com,http://*.twitter.com,http://*.x.com,http://*.instagram.com,http://*.kaggle.com,http://*.fonts.gstatic.com,http://*.url.com" \
              # æ–¹å¼2ï¼šä¹Ÿå¯ä»¥ç”¨å¤šä¸ª--excludeå‚æ•°ï¼ˆæ›´æ¸…æ™°ï¼ŒäºŒé€‰ä¸€å³å¯ï¼‰
              # --exclude "https://*.linkedin.com" \
              # --exclude "https://*.twitter.com" \
              # --exclude "https://*.x.com" \
              # --exclude "https://*.instagram.com" \
              # --exclude "http://*.linkedin.com" \
              # --exclude "http://*.twitter.com" \
              --exclude-path "**/ci.yaml" \
              --github-token ${{ secrets.GITHUB_TOKEN }} \
              --header "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.183 Safari/537.36" \
              # inputsè·¯å¾„ï¼šå»æ‰å•å¼•å·ï¼Œè®©globç”Ÿæ•ˆï¼ˆå¿…é¡»æ”¾åœ¨æœ€åï¼‰
              ./**/*.md \
              ./**/*.html | tee -a $GITHUB_STEP_SUMMARY

            # 3. æ£€æŸ¥lycheeè¾“å‡ºï¼Œå…¼å®¹ä¸åŒç‰ˆæœ¬çš„é”™è¯¯æç¤º
            if ! grep -qi "0 error(s)\|0 Errors\|0 errors\|no broken links" "$GITHUB_STEP_SUMMARY"; then
              exit 1  # æœ‰é”™è¯¯åˆ™è¿”å›é0ï¼Œè§¦å‘é‡è¯•
            fi

      - name: Test Markdown, HTML, YAML, Python and Notebook links with retry
        if: github.event_name == 'workflow_dispatch'
        uses: ultralytics/actions/retry@main
        with:
          timeout_minutes: 5
          retry_delay_seconds: 60
          retries: 2
          run: |
            # åŒæ ·çš„å‰ç½®é…ç½®
            shopt -s globstar
            set -o pipefail
            set +e

            # æ‰§è¡Œlycheeï¼ˆå‚æ•°ä¸ä¸Šä¸€æ­¥ä¸€è‡´ï¼Œä»…å¢åŠ inputsè·¯å¾„ï¼‰
            lychee \
              --scheme https \
              --timeout 60 \
              --insecure \
              --accept 100..=103,200..=299,429,999 \
              --exclude-all-private \
              # æ”¹ç”¨globæ¨¡å¼çš„excludeè§„åˆ™
              --exclude "https://*.linkedin.com,https://*.twitter.com,https://*.x.com,https://*.instagram.com,https://*.kaggle.com,https://*.fonts.gstatic.com,https://*.url.com,http://*.linkedin.com,http://*.twitter.com,http://*.x.com,http://*.instagram.com,http://*.kaggle.com,http://*.fonts.gstatic.com,http://*.url.com" \
              --exclude-path "**/ci.yaml" \
              --github-token ${{ secrets.GITHUB_TOKEN }} \
              --header "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.183 Safari/537.36" \
              # å¢åŠ æ›´å¤šinputsè·¯å¾„
              ./**/*.md \
              ./**/*.html \
              ./**/*.yml \
              ./**/*.yaml \
              ./**/*.py \
              ./**/*.ipynb | tee -a $GITHUB_STEP_SUMMARY

            # æ£€æŸ¥è¾“å‡º
            if ! grep -qi "0 error(s)\|0 Errors\|0 errors\|no broken links" "$GITHUB_STEP_SUMMARY"; then
              exit 1
            fi
